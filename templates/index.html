{% extends "base.html" %}

{% block title %}Home - Library Reader{% endblock %}

{% block content %}
<h2>Vítejte v aplikaci Library Reader</h2> 
<p>Nahraj fotku tvých knih a aplikace ti vypíše seznam knih a autorů</p>
<p>Ideálně nahraj fotku hřbetu knih vyfocených v tvé knihovně</p>
<p>Můžeš k nim přidat své hodnocení a komentáře</p>

<form method="POST" enctype="multipart/form-data">
    <input type="file" name="image" id="image">
    <input type="submit" value="Převést na text">
    <a href="{{ url_for('books') }}">Seznam všech knih</a>
</form>

<script>
    async function resizeImage(file) {
        const pica = new Pica();
        const img = document.createElement('img');
        const canvas = document.createElement('canvas');

        const reader = new FileReader();
        reader.onload = (e) => {
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);

        await new Promise((resolve) => (img.onload = resolve));

        // Calculate new dimensions while maintaining aspect ratio
        const maxWidth = 1024;
        const maxHeight = 1024;
        let width = img.width;
        let height = img.height;

        if (width > height) {
            if (width > maxWidth) {
                height = Math.round((height * maxWidth) / width);
                width = maxWidth;
            }
        } else {
            if (height > maxHeight) {
                width = Math.round((width * maxHeight) / height);
                height = maxHeight;
            }
        }

        canvas.width = width;
        canvas.height = height;

        // Resize the image
        await pica.resize(img, canvas);

        // Compress the image
        const blob = await pica.toBlob(canvas, 'image/jpeg', 0.85); // 85% quality

        return new File([blob], file.name, { type: 'image/jpeg' });
    }

    document.getElementById('image').addEventListener('change', async (event) => {
        const fileInput = event.target;
        const file = fileInput.files[0];

        if (file) {
            console.log('Original file size:', file.size / 1024, 'KB');

            // Resize and compress the image
            const resizedFile = await resizeImage(file);
            console.log('Resized file size:', resizedFile.size / 1024, 'KB');

            // Replace the original file with the resized file
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(resizedFile);
            fileInput.files = dataTransfer.files;

            console.log('File replaced with resized version.');
        }
    });
</script>

{% endblock %}